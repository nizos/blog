<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'sha256-40CawJrzluNf1nxeAkOG02xSE4t1QeakZEwxqUotM6Q='; style-src 'self'; img-src 'self'; connect-src 'self' https://plausible.io/api/event; manifest-src 'self';">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="/assets/css/main.css" rel="stylesheet" />

        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
        <link rel="manifest" href="/site.webmanifest">

        
        
        
            <meta name="description" content="Integrating automation into development workflows has become crucial in recent years. In this post, I&#39;ll share a few strategies I&#39;ve found useful for making these workflows both more efficient and sustainable. We&#39;ll look into strategies such as canceling redundant jobs, setting appropriate workflow timeouts, optimizing caching techniques, and managing workflow triggers more effectively.">
            <meta property="og:description" content="Integrating automation into development workflows has become crucial in recent years. In this post, I&#39;ll share a few strategies I&#39;ve found useful for making these workflows both more efficient and sustainable. We&#39;ll look into strategies such as canceling redundant jobs, setting appropriate workflow timeouts, optimizing caching techniques, and managing workflow triggers more effectively.">
            <meta name="description" content="Integrating automation into development workflows has become crucial in recent years. In this post, I&#39;ll share a few strategies I&#39;ve found useful for making these workflows both more efficient and sustainable. We&#39;ll look into strategies such as canceling redundant jobs, setting appropriate workflow timeouts, optimizing caching techniques, and managing workflow triggers more effectively."/>
        

        
        
            <meta property="og:image" content="/assets/images/optimizing-github-workflows-for-efficiency-and-sustainability-social-image.jpg"/>
            <meta name="twitter:image" content="/assets/images/optimizing-github-workflows-for-efficiency-and-sustainability-social-image.jpg"/>
        

        <title>
            
                Optimizing GitHub Workflows for Efficiency and Sustainability | Nizar&#39;s Blog
            
        </title>

        <meta property="og:site_name" content="Nizar's Blog">
        <meta property="og:type" content="website">
        <script defer data-domain="nizar.se" src="https://plausible.io/js/script.js" integrity="sha256-40CawJrzluNf1nxeAkOG02xSE4t1QeakZEwxqUotM6Q=" crossorigin="anonymous"></script>
    </head>
    <body>
        <div class="layout-wrapper">
            <header class="header">
    <div class="header__content">
        <h1 class="site-title">
            <a href="/">Nizar's Blog</a>
        </h1>
        <nav class="nav">
            <ul class="nav__list">
                <li class="nav-item">
                    <a href="/about">About</a>
                </li>
            </ul>
        </nav>
    </div>
</header>
            <main class="main">
                <article class="post">
    <header class="post__header">
        <h1>Optimizing GitHub Workflows for Efficiency and Sustainability</h1>
        <div class="post__details">
            <time>12 Jun 2024</time>
            <span> | </span>
            <span>5 minutes</span>
        </div>
    </header>

    <div class="post__cover">
        <picture><source type="image/avif" srcset="/optimizing-github-workflows-for-efficiency-and-sustainability/SCWLZmHAc6-300.avif 300w, /optimizing-github-workflows-for-efficiency-and-sustainability/SCWLZmHAc6-600.avif 600w, /optimizing-github-workflows-for-efficiency-and-sustainability/SCWLZmHAc6-750.avif 750w, /optimizing-github-workflows-for-efficiency-and-sustainability/SCWLZmHAc6-900.avif 900w, /optimizing-github-workflows-for-efficiency-and-sustainability/SCWLZmHAc6-1200.avif 1200w, /optimizing-github-workflows-for-efficiency-and-sustainability/SCWLZmHAc6-1400.avif 1400w" sizes="Cover image"><source type="image/jpeg" srcset="/optimizing-github-workflows-for-efficiency-and-sustainability/SCWLZmHAc6-300.jpeg 300w, /optimizing-github-workflows-for-efficiency-and-sustainability/SCWLZmHAc6-600.jpeg 600w, /optimizing-github-workflows-for-efficiency-and-sustainability/SCWLZmHAc6-750.jpeg 750w, /optimizing-github-workflows-for-efficiency-and-sustainability/SCWLZmHAc6-900.jpeg 900w, /optimizing-github-workflows-for-efficiency-and-sustainability/SCWLZmHAc6-1200.jpeg 1200w, /optimizing-github-workflows-for-efficiency-and-sustainability/SCWLZmHAc6-1400.jpeg 1400w" sizes="Cover image"><img alt="Cover image" loading="lazy" decoding="async" src="/optimizing-github-workflows-for-efficiency-and-sustainability/SCWLZmHAc6-300.jpeg" width="1400" height="787"></picture>
        <p class="post__cover-caption">Original photo by <a href="https://unsplash.com/@bfigas">Bruno Figueiredo</a> on <a href="https://unsplash.com/photos/white-windmill-during-day-KAXSflHqAl0">Unsplash</a></p>
    </div>

    <main class="post__content">
        <p>Integrating automation into development workflows has become crucial in recent years. In this post, I'll share a few
strategies I've found useful for making these workflows both more efficient and sustainable. We'll look into strategies
such as canceling redundant jobs, setting appropriate workflow timeouts, optimizing caching techniques, and managing
workflow triggers more effectively.</p>
<h2>Cancel Redundant Jobs</h2>
<p>When active development branches receive rapid updates, whether through direct pushes or pull requests, they often
trigger multiple instances of the same workflow. This redundancy can lead to unnecessary resource consumption and
potential delays in integration processes.</p>
<p>One effective solution is to utilize <a href="https://docs.github.com/en/enterprise-cloud@latest/actions/using-jobs/using-concurrency#using-concurrency-in-different-scenarios">concurrency groups</a>.
By assigning a concurrency key, you can group workflows, thereby controlling their execution more effectively.
GitHub ensures that within a concurrency group, only one job or workflow runs at a time, limiting it to one running
and one pending job. Any new jobs that are triggered at that point will instead be queued.</p>
<p>However, by setting <code>cancel-in-progress</code> to true, we cancel any ongoing workflows within the same concurrency group
when a new one is triggered. This approach effectively clears the queue and ensures that any running workflows are
processing the latest changes:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">on</span><span class="token punctuation">:</span><br>  <span class="token key atrule">push</span><span class="token punctuation">:</span><br>    <span class="token key atrule">branches</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> main<br><br><span class="token key atrule">concurrency</span><span class="token punctuation">:</span><br>  <span class="token key atrule">group</span><span class="token punctuation">:</span> integration<span class="token punctuation">-</span>tests<br>  <span class="token key atrule">cancel-in-progress</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code></pre>
<p>For more granular control, particularly useful in environments that utilize branching strategies, consider using dynamic
expressions in the group naming. This configuration allows workflows triggered on different branches to be grouped
separately, ensuring that updates on one branch do not interfere with the progress of workflows on another:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">concurrency</span><span class="token punctuation">:</span><br>  <span class="token key atrule">group</span><span class="token punctuation">:</span> integration<span class="token punctuation">-</span>tests<span class="token punctuation">-</span>$<span class="token punctuation">{</span><span class="token punctuation">{</span> github.ref <span class="token punctuation">}</span><span class="token punctuation">}</span><br>  <span class="token key atrule">cancel-in-progress</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code></pre>
<p>Employing this strategy optimizes the use of CI resources by avoiding redundant or outdated jobs while maintaining the
integrity of our codebase across all types of updates.</p>
<h2>Set Workflow Timeouts</h2>
<p>The default workflow timeout is 6 hours, which is often excessive for processes that complete within minutes.
Setting a more appropriate duration prevents wasteful use of resources, especially in cases where a process might
hang due to issues like deadlocks, resource starvation, or software bugs. For instance, a lint check that typically
completes within two minutes might only need a 10-minute timeout:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">jobs</span><span class="token punctuation">:</span><br>  <span class="token key atrule">lint-checks</span><span class="token punctuation">:</span><br>    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest<br>    <span class="token key atrule">timeout-minutes</span><span class="token punctuation">:</span> <span class="token number">10</span></code></pre>
<p>This simple adjustment prevents resources from being idly consumed, allowing them to be used for more critical tasks
and thereby enhancing the sustainability of your workflows.</p>
<h2>Utilize Caching for Efficiency</h2>
<h3>Optimize Dependency Handling</h3>
<p>Workflow runs often share the exact same dependencies, which must be downloaded each time. Efficient caching can save
both time and resources. I recommend using the <a href="https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows#about-caching-workflow-dependencies">setup actions</a>
for setting up environments like Node.js with caching enabled:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Setup Node.js<br>  <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v4<br>  <span class="token key atrule">with</span><span class="token punctuation">:</span><br>    <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token number">20</span><br>    <span class="token key atrule">cache</span><span class="token punctuation">:</span> <span class="token string">'npm'</span></code></pre>
<p>This configuration caches the <code>~/.npm</code> directory, which stores tarballs and metadata rather than the <code>node_modules</code>,
reducing size and enhancing reusability across different environments.</p>
<p>Using <code>npm ci</code> instead of <code>npm install</code> further accelerates builds by installing exact versions from the
<code>package-lock.json</code>, ensuring reproducible builds and eliminating dependency resolution delays.</p>
<h3>Cache and Restore Build Assets</h3>
<p>For assets that are resource-intensive to recreate and don't frequently change, consider using the
<a href="https://github.com/actions/cache">cache action</a>:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">jobs</span><span class="token punctuation">:</span><br>  <span class="token key atrule">build</span><span class="token punctuation">:</span><br>    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest<br>    <span class="token key atrule">steps</span><span class="token punctuation">:</span><br><br>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Cache Assets<br>        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/cache@v4<br>        <span class="token key atrule">with</span><span class="token punctuation">:</span><br>          <span class="token key atrule">path</span><span class="token punctuation">:</span> assets<br>          <span class="token key atrule">key</span><span class="token punctuation">:</span> assets<span class="token punctuation">-</span>$<span class="token punctuation">{</span><span class="token punctuation">{</span> github.run_id <span class="token punctuation">}</span><span class="token punctuation">}</span><br>          <span class="token key atrule">restore-keys</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"><br>            assets-</span></code></pre>
<p>This configuration caches the <code>assets</code> directory, restoring it at the start of each build.
By referencing the run ID in the cache key, each build attempt will initially seek its own unique cache.
If there isn’t an exact match, the <code>restore-keys</code> option allows the build to use the most recent cache starting
with <code>assets-</code>. This technique is particularly useful for processes like generating responsive images, where restoring
them from the cache can save significant time and resources.</p>
<p>Note: GitHub retains caches for 7 days after the last access. For infrequent workflows, a storage-based solution might
be more appropriate. Cache management, including invalidation, can be handled through the repository's <a href="https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows#deleting-cache-entries">web interface</a>.</p>
<h2>Optimize Workflow Triggers</h2>
<p>Efficiently using <code>paths</code> and <code>paths-ignore</code> to specify which files or directories should trigger workflows can help
focus resources on meaningful changes.</p>
<p>For instance, to exclude documentation updates from triggering workflows:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">on</span><span class="token punctuation">:</span><br>  <span class="token key atrule">push</span><span class="token punctuation">:</span><br>    <span class="token key atrule">paths-ignore</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> <span class="token string">'docs/**'</span></code></pre>
<p>This configuration prevents any change in the <code>docs</code> directory from triggering the workflow, conserving resources for
non-code updates.</p>
<p>To trigger workflows only for changes in front-end code (e.g., JavaScript files):</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">on</span><span class="token punctuation">:</span><br>  <span class="token key atrule">push</span><span class="token punctuation">:</span><br>    <span class="token key atrule">paths</span><span class="token punctuation">:</span><br>      <span class="token punctuation">-</span> <span class="token string">'frontend/**.js'</span></code></pre>
<p>This setting ensures that workflows are triggered only when <code>js</code> files in the <code>frontend</code> directory are modified,
ensuring relevant tasks like linting are executed only when necessary.</p>
<p>For more advanced usage, refer to the official GitHub Actions documentation <a href="https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#onpushpull_requestpull_request_targetpathspaths-ignore">here</a>.
Feel free to also check out the <a href="https://github.com/dorny/paths-filter">paths-filter</a> action which offers more advanced
features.</p>
<h2>Leverage ARM Architecture for Efficiency</h2>
<p>GitHub recently announced <a href="https://github.blog/2024-06-03-arm64-on-github-actions-powering-faster-more-efficient-build-systems/">ARM-based runners</a>
for GitHub Team and Enterprise Cloud plans, with plans to offer them for open-source projects before the year's end.</p>
<p>These runners provide improvements in speed and energy consumption due to their reduced instruction set. They consume
30-40% less energy for some of the most widely deployed workflows and are 37% cheaper than their x64 counterparts.</p>
<p>However, not all workflows are ideal for ARM runners, especially those that depend on software or libraries not yet
optimized for ARM architecture, or that rely on x64-specific optimizations. Testing and evaluating your workflows will
help you identify any compatibility issues and measure the potential benefits in terms of speed, cost, and energy
consumption.</p>
<p>To utilize these ARM runners in your workflows, you first need to create an ARM-based runner as shown in <a href="https://www.youtube.com/watch?v=cgI6SBP8pEM">this video</a>
or documented <a href="https://docs.github.com/en/actions/using-github-hosted-runners/about-larger-runners/about-larger-runners">here</a>.
Once set up, you can specify the runner by its name in the <code>runs-on</code> field in your GitHub Actions workflow. For example:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">jobs</span><span class="token punctuation">:</span><br>  <span class="token key atrule">build</span><span class="token punctuation">:</span><br>    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>org<span class="token punctuation">-</span>arm<span class="token punctuation">-</span>runner</code></pre>
<p>This configuration directs GitHub Actions to use the specified ARM-based runner, allowing you to take advantage of the
efficiency and cost savings offered by ARM architecture.</p>
<h2>Estimate Workflow Energy Consumption</h2>
<p>Determining which strategy consumes fewer resources can sometimes be challenging. Tools like the <a href="https://github.com/green-coding-solutions/eco-ci-energy-estimation">eco-ci-energy-estimation</a>
action allow us to get estimates and help us make informed decisions.</p>
<p>For instance, to determine whether caching npm dependencies would reduce resource consumption, I ran 5 workflow runs
with caching and 5 without. The result showed that caching npm dependencies reduced overall energy consumption and time.</p>
<p><picture><source type="image/avif" srcset="/optimizing-github-workflows-for-efficiency-and-sustainability/f1tmCI3rWa-300.avif 300w, /optimizing-github-workflows-for-efficiency-and-sustainability/f1tmCI3rWa-600.avif 600w, /optimizing-github-workflows-for-efficiency-and-sustainability/f1tmCI3rWa-750.avif 750w" sizes="100vw"><source type="image/jpeg" srcset="/optimizing-github-workflows-for-efficiency-and-sustainability/f1tmCI3rWa-300.jpeg 300w, /optimizing-github-workflows-for-efficiency-and-sustainability/f1tmCI3rWa-600.jpeg 600w, /optimizing-github-workflows-for-efficiency-and-sustainability/f1tmCI3rWa-750.jpeg 750w" sizes="100vw"><img alt="Energy comparison of using caching vs not using caching" loading="lazy" decoding="async" src="/optimizing-github-workflows-for-efficiency-and-sustainability/f1tmCI3rWa-300.jpeg" width="750" height="366"></picture>
<em>Energy comparison of using caching vs not using caching</em></p>
<p>The following example demonstrates how to integrate this measurement tool into a workflow. Call <code>start-measurement</code>
before running the work to be measured, and <code>get-measurement</code> and <code>display-results</code> after.</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Initialize Energy Estimation<br>  <span class="token key atrule">uses</span><span class="token punctuation">:</span> green<span class="token punctuation">-</span>coding<span class="token punctuation">-</span>solutions/eco<span class="token punctuation">-</span>ci<span class="token punctuation">-</span>energy<span class="token punctuation">-</span>estimation@v3<br>  <span class="token key atrule">with</span><span class="token punctuation">:</span><br>    <span class="token key atrule">task</span><span class="token punctuation">:</span> start<span class="token punctuation">-</span>measurement<br><br><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Tests measurement<br>  <span class="token key atrule">uses</span><span class="token punctuation">:</span> green<span class="token punctuation">-</span>coding<span class="token punctuation">-</span>solutions/eco<span class="token punctuation">-</span>ci<span class="token punctuation">-</span>energy<span class="token punctuation">-</span>estimation@v3<br>  <span class="token key atrule">with</span><span class="token punctuation">:</span><br>    <span class="token key atrule">task</span><span class="token punctuation">:</span> get<span class="token punctuation">-</span>measurement<br>    <span class="token key atrule">label</span><span class="token punctuation">:</span> <span class="token string">'Install'</span><br><br><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Show Energy Results<br>  <span class="token key atrule">uses</span><span class="token punctuation">:</span> green<span class="token punctuation">-</span>coding<span class="token punctuation">-</span>solutions/eco<span class="token punctuation">-</span>ci<span class="token punctuation">-</span>energy<span class="token punctuation">-</span>estimation@v3<br>  <span class="token key atrule">with</span><span class="token punctuation">:</span><br>    <span class="token key atrule">task</span><span class="token punctuation">:</span> display<span class="token punctuation">-</span>results</code></pre>
<p>Upon completion, the workflow produces a summary that looks like this:</p>
<p><picture><source type="image/avif" srcset="/optimizing-github-workflows-for-efficiency-and-sustainability/zx3fsUhZ8L-300.avif 300w, /optimizing-github-workflows-for-efficiency-and-sustainability/zx3fsUhZ8L-600.avif 600w, /optimizing-github-workflows-for-efficiency-and-sustainability/zx3fsUhZ8L-750.avif 750w, /optimizing-github-workflows-for-efficiency-and-sustainability/zx3fsUhZ8L-900.avif 900w, /optimizing-github-workflows-for-efficiency-and-sustainability/zx3fsUhZ8L-1200.avif 1200w, /optimizing-github-workflows-for-efficiency-and-sustainability/zx3fsUhZ8L-1400.avif 1400w" sizes="100vw"><source type="image/jpeg" srcset="/optimizing-github-workflows-for-efficiency-and-sustainability/zx3fsUhZ8L-300.jpeg 300w, /optimizing-github-workflows-for-efficiency-and-sustainability/zx3fsUhZ8L-600.jpeg 600w, /optimizing-github-workflows-for-efficiency-and-sustainability/zx3fsUhZ8L-750.jpeg 750w, /optimizing-github-workflows-for-efficiency-and-sustainability/zx3fsUhZ8L-900.jpeg 900w, /optimizing-github-workflows-for-efficiency-and-sustainability/zx3fsUhZ8L-1200.jpeg 1200w, /optimizing-github-workflows-for-efficiency-and-sustainability/zx3fsUhZ8L-1400.jpeg 1400w" sizes="100vw"><img alt="Workflow summary showing measurement estimates" loading="lazy" decoding="async" src="/optimizing-github-workflows-for-efficiency-and-sustainability/zx3fsUhZ8L-300.jpeg" width="1400" height="1022"></picture>
<em>Workflow summary showing measurement estimates</em></p>
<p>The action sends metrics data to metrics.green-coding.io by default, including energy values, duration of measurements,
CPU model, and details about your repository and commit. This data is used to create a badge and a detailed display of
your CI runs’ energy consumption, viewable <a href="https://metrics.green-coding.io/ci-index.html">here</a>.</p>
<p>If you prefer not to share this data, simply set <code>send-data</code> to <code>false</code> in the action’s configuration.</p>
<h2>More Ways to Optimize Workflows</h2>
<p>With these simple tips, you can significantly reduce costs, save time, and better allocate resources. For more tips,
I highly recommend the presentation &quot;<a href="https://www.youtube.com/watch?v=mYBkSg1dz2Y">Things your Pipeline Should (Not) Do</a>&quot;
by my colleague Raniz, who inspired me to write this post.</p>

    </main>

    <aside class="post__aside">
        <div class="post__tags">
            
            
                
                <a href="/tags/ci/">#ci</a>
            
                
                <a href="/tags/automation/">#automation</a>
            
                
                <a href="/tags/sustainability/">#sustainability</a>
            
        </div>
    </aside>
</article>

            </main>

            <footer class="footer">
    <div class="footer__content">
        <p class="footer__attribution">Powered by <a href="https://www.11ty.dev">11ty</a>, based on <a href="https://github.com/yinkakun/eleventy-duo">Eleventy Duo</a></p>
    </div>
</footer>
        </div>
    </body>
</html>