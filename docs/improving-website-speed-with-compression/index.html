<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'sha256-llOHzpSJ0BZ88zREq1LQZLs/qzXpSxIIL/XrAKNMBww='; style-src 'self'; img-src 'self'; connect-src 'self'; manifest-src 'self';">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="/assets/css/main.css" rel="stylesheet" />

        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
        <link rel="manifest" href="/site.webmanifest">

        
        
        
            <meta name="description" content="Compression plays a vital role in the modern web. It helps us deliver content faster to users while preserving network resources. With technologies like Gzip and Brotli, we can make websites more efficient without compromising the quality of the data. In this post, we will explore how to improve website speed by leveraging HTTP compression and pre-compressing files.">
            <meta property="og:description" content="Compression plays a vital role in the modern web. It helps us deliver content faster to users while preserving network resources. With technologies like Gzip and Brotli, we can make websites more efficient without compromising the quality of the data. In this post, we will explore how to improve website speed by leveraging HTTP compression and pre-compressing files.">
            <meta name="description" content="Compression plays a vital role in the modern web. It helps us deliver content faster to users while preserving network resources. With technologies like Gzip and Brotli, we can make websites more efficient without compromising the quality of the data. In this post, we will explore how to improve website speed by leveraging HTTP compression and pre-compressing files."/>
        

        
        
            <meta property="og:image" content="/assets/images/improving-website-speed-with-compression-social-image.jpg"/>
            <meta name="twitter:image" content="/assets/images/improving-website-speed-with-compression-social-image.jpg"/>
        

        <title>
            
                Improving Website Speed with Compression | Nizar&#39;s Blog
            
        </title>

        <meta property="og:site_name" content="Nizar's Blog">
        <meta property="og:type" content="website">
        <script defer data-domain="nizar.se" src="https://plausible.io/js/script.js" integrity="sha256-llOHzpSJ0BZ88zREq1LQZLs/qzXpSxIIL/XrAKNMBww=" crossorigin="anonymous"></script>
    </head>
    <body>
        <div class="layout-wrapper">
            <header class="header">
    <div class="header__content">
        <h1 class="site-title">
            <a href="/">Nizar's Blog</a>
        </h1>
        <nav class="nav">
            <ul class="nav__list">
                <li class="nav-item">
                    <a href="/about">About</a>
                </li>
            </ul>
        </nav>
    </div>
</header>
            <main class="main">
                <article class="post">
    <header class="post__header">
        <h1>Improving Website Speed with Compression</h1>
        <div class="post__details">
            <time>26 Jun 2023</time>
            <span> | </span>
            <span>6 minutes</span>
        </div>
    </header>

    <div class="post__cover">
        <picture><source type="image/avif" srcset="/improving-website-speed-with-compression/GOf83sVPBR-300.avif 300w, /improving-website-speed-with-compression/GOf83sVPBR-600.avif 600w, /improving-website-speed-with-compression/GOf83sVPBR-750.avif 750w, /improving-website-speed-with-compression/GOf83sVPBR-900.avif 900w, /improving-website-speed-with-compression/GOf83sVPBR-1200.avif 1200w, /improving-website-speed-with-compression/GOf83sVPBR-1400.avif 1400w" sizes="Cover image"><source type="image/jpeg" srcset="/improving-website-speed-with-compression/GOf83sVPBR-300.jpeg 300w, /improving-website-speed-with-compression/GOf83sVPBR-600.jpeg 600w, /improving-website-speed-with-compression/GOf83sVPBR-750.jpeg 750w, /improving-website-speed-with-compression/GOf83sVPBR-900.jpeg 900w, /improving-website-speed-with-compression/GOf83sVPBR-1200.jpeg 1200w, /improving-website-speed-with-compression/GOf83sVPBR-1400.jpeg 1400w" sizes="Cover image"><img alt="Cover image" loading="lazy" decoding="async" src="/improving-website-speed-with-compression/GOf83sVPBR-300.jpeg" width="1400" height="934"></picture>
        <p class="post__cover-caption">Photo by <a href="https://unsplash.com/@mbaumi">Mika Baumeister</a> on <a href="https://unsplash.com/photos/Wpnoqo2plFA">Unsplash</a></p>
    </div>

    <main class="post__content">
        <p>Google engineers, Arvind Jain and Jason Glasgow, stated that more than 99 human years are wasted every day because of uncompressed content [<a href="https://developers.googleblog.com/2009/11/use-compression-to-make-web-faster.html" title="Use compression to make the web faster">1</a>]. That was in 2009. Advancements in technology have since then brought improvements to internet speed, connectivity, and coverage. However, a lot has also changed on the web and how we use it.</p>
<p>Between 2012 and 2022, the average desktop page size increased from 803 KB to 2,284 KB. For mobile, it increased from 386 KB to 2,010 KB. A staggering increase of 184% and 420% respectively in a single decade [<a href="https://www.keycdn.com/support/the-growth-of-web-page-size" title="The Growth of Web Page Size">2</a>].</p>
<p>During the same period, the number of internet users has also more than doubled, increasing from roughly 2.2 to 5.3 billion internet users, an increase from roughly 35% to 66% of the world population that use the internet [<a href="https://www.itu.int/hub/publication/d-ind-ict_mdd-2022" title="Measuring digital development: Facts and Figures 2022">3</a>].</p>
<p>At the risk of preaching to the choir, the minute performance improvements we make to the websites we create accumulate to astounding and far-reaching impacts. Their importance and significance can not be understated, especially considering how simple some of them are. In this post, we'll explore how to improve website speed by leveraging HTTP compression and pre-compressing files.</p>
<h2>HTTP Compression</h2>
<p>One technique that has significantly contributed to website speed improvement is HTTP compression. This seamless capability in our web servers and browsers, which can easily go unnoticed, improves transfer speed and bandwidth utilization by compressing HTTP data before sending it. The scheme used for the compression is negotiated through the client advertising methods it supports.</p>
<pre class="language-text"><code class="language-text">GET /encrypted-area HTTP/1.1<br>Host: www.example.com<br>Accept-Encoding: gzip, deflate</code></pre>
<p>The server can also support multiple compression schemes. In such a case, the server lists them in the <code>Content-Encoding</code> or <code>Transfer-Encoding</code> field in the HTTP response.</p>
<pre class="language-text"><code class="language-text">HTTP/1.1 200 OK<br>Date: mon, 26 June 2016 22:38:34 GMT<br>Server: Apache/1.3.3.7 (Unix)  (Red-Hat/Linux)<br>Last-Modified: Wed, 08 Jan 2003 23:11:55 GMT<br>Accept-Ranges: bytes<br>Content-Length: 438<br>Connection: close<br>Content-Type: text/html; charset=UTF-8<br>Content-Encoding: gzip</code></pre>
<h2>Compression Schemes</h2>
<p>The two most common compression schemes used today are Gzip (<code>gzip</code>) and Brotli (<code>br</code>).</p>
<p>Gzip, the older of the two, was released in 1993 during the formative years of the internet. It was created to compress files and has since been adapted to compress streams. Brotli on the other hand, which was released in 2013 by Google, was designed from the ground up to compress streams making it a preferred scheme for web.</p>
<p>Both Gzip and Brotli combine variations of the <a href="https://en.wikipedia.org/wiki/LZ77_and_LZ78">LZ77</a> algorithm and <a href="https://en.wikipedia.org/wiki/Huffman_coding">Huffman coding</a>, among others, to provide lossless general-purpose compression.</p>
<p>LZ77 replaces repeated occurrences of data with references to a single copy of it using an encoded length-distance pair. This match effectively states that the length following characters are identical to the characters distance before them. This algorithm formed the basis of compression schemes such as GIF and the deflate algorithm used in PNG and ZIP.</p>
<p>The Huffman coding algorithm further compresses the data by using a dictionary of recurring characters and their frequency. Characters, and groups of which, are replaced by variable-length codes based on their occurrence with more frequent ones being assigned shorter codes.</p>
<p>Brotli is further able to reach higher compression density by utilizing context models and other improvements. It also uses a pre-defined dictionary along its dynamic memory, roughly 120 KiB containing 13,000 common words, phrases and substrings derived from internet documents.</p>
<p>This allows Brotli to reach compression densities that are roughly 15% denser for JavaScript and CSS files, and 20% denser for HTML files compared to Gzip. That said, Brotli can also take longer to compress data compared to Gzip. The higher the level of compression, the longer it takes.</p>
<h2>Pre-Compressing Files</h2>
<p>While compression significantly reduces the size of transmitted data, it also happens at run time and as such impedes performance due to the required processing overhead. Luckily, we can utilize modules that allow us to serve pre-compressed files, effectively eliminating all the processing overhead at runtime. This is ideal for serving static content and static files.</p>
<p>We will have to first compress our files. The <code>node:zlib</code> module provides all the compression functionality needed to do so using Gzip and Brotli. The documentation provides an example of how to accomplish this by piping the source stream (file) through a <code>zlib</code> Transform into a destination stream.</p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">{</span> createGzip <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node:zlib'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token punctuation">{</span> pipeline <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node:stream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> <span class="token punctuation">{</span><br>  createReadStream<span class="token punctuation">,</span><br>  createWriteStream<span class="token punctuation">,</span><br><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'node:fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> gzip <span class="token operator">=</span> <span class="token function">createGzip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'input.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> destination <span class="token operator">=</span> <span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'input.txt.gz'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token function">pipeline</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> gzip<span class="token punctuation">,</span> destination<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'An error occurred:'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    process<span class="token punctuation">.</span>exitCode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>For Brotli, we simply replace the Gzip object with a <code>BrotliCompress</code> object. We can call <code>createBrotliCompress()</code> instead of <code>createGzip()</code> to create our transform stream. Additionally, we can pass an <code>options</code> object to specify the compression level and fine-tune other parameters to our liking.</p>
<p>We then simply create the necessary functionality to recursively iterate through the files in our build directory and create <code>.gz</code> and <code>.br</code> compressed files next to the uncompressed files. Finally, we add the command to our build script and have it automatically execute as a final build step.</p>
<h2>Serving Pre-Compressed Files</h2>
<p>For NGINX, we can use <a href="https://nginx.org/en/docs/http/ngx_http_gzip_static_module.html#gzip_static">ngx_http_gzip_static_module</a> for Gzip and <a href="https://github.com/google/ngx_brotli#brotli_static">ngx_brotli</a> for Brotli precompressed files. These allow us to precompress our files and have them served as such.</p>
<p>Nginx uses a nifty tool called <a href="https://hg.nginx.org/pkg-oss/">pkg-oss</a> to create the dynamic module packages for their official repositories. It contains a script that automates the process, which we can use to create installable packages with the correct dependencies for our modules.</p>
<p>This method ensures that the dependency between our modules and NGINX is honored, facilitating seamless upgrades and avoiding upgrade failures. The code block below shows how we can use it to create <code>deb</code> packages for our <code>ngx_brotli</code> module. You can use <code>curl</code> or any other similar tool instead of <code>wget</code>.</p>
<pre class="language-text"><code class="language-text">wget https://hg.nginx.org/pkg-oss/raw-file/default/build_module.sh<br>chmod a+x build_module.sh<br>./build_module.sh -v 1.23.3 --force-dynamic https://github.com/google/ngx_brotli.git</code></pre>
<p>Do note however that this should be done in a separate build environment to ensure that only operation-necessary software is installed on the production server. Further, this script might not work for every module and the installable packages created by it are not intended for distribution. Finally, seamless upgrades require a <code>yum</code> or <code>apt</code> repository. For instructions and more information, check out Liam Crillys article <a href="https://www.nginx.com/blog/creating-installable-packages-dynamic-modules/">Creating Installable Packages for Dynamic Modules</a>.</p>
<p>Upon completion, the script outputs the path of the created <code>deb</code> packages which we can install with the help of <code>dpkg</code>.</p>
<pre class="language-shell"><code class="language-shell">dpkg <span class="token parameter variable">-i</span> nginx-module-brotli_1.23.3+1.0-1~jammy_amd64.deb</code></pre>
<p>We then need to configure NGINX to use the newly installed module. We do this by editing the main configuration file.</p>
<pre class="language-shell"><code class="language-shell"><span class="token function">nano</span> /etc/nginx/nginx.conf</code></pre>
<p>We simply add the directive we are interested in to the http block. For example:</p>
<pre class="language-text"><code class="language-text">brotli on;<br>brotli_comp_level 6;<br>brotli_static on;<br>brotli_types application/atom+xml application/javascript<br>  application/json application/rss+xml application/vnd.ms-fontobject<br>  application/x-font-opentype application/x-font-truetype<br>  application/x-font-ttf application/x-javascript<br>  application/xhtml+xml application/xml font/eot font/opentype<br>  font/otf font/truetype image/svg+xml image/vnd.microsoft.icon<br>  image/x-icon image/x-win-bitmap text/css text/javascript<br>  text/plain text/xml;</code></pre>
<ul>
<li><code>brotli</code>: Enables on-the-fly compression of responses.</li>
<li><code>brotli_comp_level</code>: Sets the on-the-fly compression levels. Range is 0 - 11, default is 6.</li>
<li><code>brotli_static</code>: Enables checking for pre-compressed files with .br extension.</li>
<li><code>brotli_types</code>: MIME types to enable on-the-fly compression for.</li>
</ul>
<p>Check the official <a href="https://github.com/google/ngx_brotli">ngx_brotli</a> repo for additional information and configuration.</p>
<p>Check for any syntax errors after saving with the following command:</p>
<pre class="language-shell"><code class="language-shell">nginx <span class="token parameter variable">-t</span></code></pre>
<p>The output should look something like this:</p>
<pre class="language-text"><code class="language-text">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok<br>nginx: configuration file /etc/nginx/nginx.conf test is successful</code></pre>
<p>Finally, restart NGINX to apply the changes.</p>
<pre class="language-shell"><code class="language-shell">systemctl restart nginx</code></pre>
<p>NGINX is now configured with Brotli support. You can verify this by running the following command:</p>
<pre class="language-text"><code class="language-text">curl -H ‘Accept-Encoding: br’ -I https://your-website.com</code></pre>
<p>The result should contain the following line:</p>
<pre class="language-text"><code class="language-text">content-encoding: br</code></pre>
<p>Be also sure to test your improved website speed by using PageSpeed Insights, Lighthouse or any other tool you prefer. Your numbers may vary depending on several factors such as existing bottlenecks, but you should see an improvement.</p>
<h2>Results</h2>
<p>After compressing and serving static files, the loading speed of my website improved significantly. However, don't just take my word for it. Let's examine some real-world examples that illustrate the effectiveness of compression.</p>
<p>Here is how the time-to-interactive changed on mobile for the following sites:</p>
<ul>
<li>Organization website: Reduced from 1.5 to 0.9 seconds.</li>
<li>Conference website: Reduced from 1.4 to 1.0 seconds.</li>
</ul>
<p>These are just a few examples of how powerful compression can be in improving website speed. With the easy implementation and significant benefits, it is clear why HTTP compression and pre-compressing files have become standard practice in web development.</p>
<h2>Conclusion</h2>
<p>Compression plays a vital role in the modern web. It helps us deliver content faster to users while preserving network resources. With technologies like Gzip and Brotli, we can make websites more efficient without compromising the quality of the data. As the internet continues to grow and evolve, we can only expect compression techniques to become even more critical. In future posts, we'll explore more ways to improve website performance and make the most of available resources.</p>
<h2>References</h2>
<ol>
<li><a href="https://developers.googleblog.com/2009/11/use-compression-to-make-web-faster.html">https://developers.googleblog.com/2009/11/use-compression-to-make-web-faster.html</a></li>
<li><a href="https://www.keycdn.com/support/the-growth-of-web-page-size">https://www.keycdn.com/support/the-growth-of-web-page-size</a></li>
<li><a href="https://www.itu.int/hub/publication/d-ind-ict_mdd-2022">https://www.itu.int/hub/publication/d-ind-ict_mdd-2022</a></li>
</ol>

    </main>

    <aside class="post__aside">
        <div class="post__tags">
            
            
                
                <a href="/tags/gzip/">#gzip</a>
            
                
                <a href="/tags/br/">#br</a>
            
                
                <a href="/tags/nginx/">#nginx</a>
            
                
                <a href="/tags/web/">#web</a>
            
        </div>
    </aside>
</article>

            </main>

            <footer class="footer">
    <div class="footer__content">
        <p class="footer__attribution">Powered by <a href="https://www.11ty.dev">11ty</a>, based on <a href="https://github.com/yinkakun/eleventy-duo">Eleventy Duo</a></p>
    </div>
</footer>
        </div>
    </body>
</html>